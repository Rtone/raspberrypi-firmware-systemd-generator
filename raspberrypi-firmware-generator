#!/bin/bash
#  SPDX-License-Identifier: LGPL-2.1-or-later
#
#  This file is part of raspberrypi-firmware-systemd-generator.
#
#  raspberrypi-firmware-systemd-generator is free software; you can
#  redistribute it and/or modify it under the terms of the GNU Lesser
#  General Public License as published by the Free Software Foundation;
#  version 2.1 of the License.
#

if ! part="$(fdtget /sys/firmware/fdt /chosen/bootloader partition)"
then
	exit 1
fi

if ! part="$(("0x$part"))"
then
	exit 1
fi

if [[ "$part" -eq 0 ]]
then
	exit 1
fi

mapfile -t parts < <(lsblk --noheadings --output PATH \
			   --filter 'PARTTYPE == "c12a7328-f81f-11d2-ba4b-00a0c93ec93b"
			          OR PARTTYPE == "ebd0a0a2-b9e5-4433-87c0-68b6b72699c7"
			          OR PARTTYPE == "0xc"')
what="${parts[((part-1))]}"
if [[ ! "$what" ]]
then
	exit 1
fi

if ! unit="$(systemd-escape boot/firmware.mount)"
then
	exit 1
fi

mkdir -p "$1"
cat <<EOF >"$1/$unit"
# Automatically generated by ${0##*/}"

[Unit]
Documentation=https://www.raspberrypi.com/documentation/computers/config_txt.html#autoboot-txt
Documentation=https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#fail-safe-os-updates-tryboot
SourcePath=/sys/firmware/devicetree/base/chosen/bootloader/partition
Before=local-fs.target
After=-boot.mount

[Mount]
What=$what
Where=/boot/firmware
Type=vfat
Options=rw
EOF
mkdir -p "$1/local-fs.target.wants"
ln -sf "../$unit" "$1/local-fs.target.wants/$unit"
